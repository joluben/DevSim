<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevSim - Simulador de se√±ales de dispositivos</title>
    <link rel="stylesheet" href="styles.css">
    
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-content">
                <div class="logo">
                    <div class="logo-text">
                        <h1>Device Simulator</h1>
                        <p>Gesti√≥n de Dispositivos y Conexiones</p>
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <button id="nav-projects" class="nav-btn" data-i18n="common.navigation.projects">Proyectos</button>
                    <button id="nav-devices" class="nav-btn active" data-i18n="common.navigation.devices">Dispositivos</button>
                    <button id="nav-connections" class="nav-btn" data-i18n="common.navigation.connections">Conexiones</button>
                </nav>
            </div>
            
            <!-- Selector de Idioma -->
            <div class="language-selector">
                <button id="language-selector" class="language-btn" title="Cambiar idioma">
                    üåê <span data-i18n="common.language.current">Espa√±ol</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="container">

        <!-- Vista: Lista de Dispositivos -->
        <div id="devices-list-view" class="view active">
            <div class="view-header">
                <h2 data-i18n="devices.title">Dispositivos</h2>
                <button id="btn-new-device" class="btn btn-primary" data-i18n="devices.create_device">Nuevo Dispositivo</button>
            </div>
            
            <div class="devices-grid" id="devices-grid">
                <div class="loading" id="devices-loading">Cargando dispositivos...</div>
            </div>
        </div>

        <!-- Vista: Crear Dispositivo -->
        <div id="create-device-view" class="view">
            <div class="view-header">
                <h2>Crear Dispositivo</h2>
                <button id="btn-back-to-list" class="btn btn-secondary">Volver</button>
            </div>
            
            <form id="create-device-form" class="form">
                <div class="form-group">
                    <label for="device-name">Nombre *</label>
                    <input type="text" id="device-name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="device-description">Descripci√≥n</label>
                    <textarea id="device-description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Crear Dispositivo</button>
                    <button type="button" id="btn-cancel-create" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Vista: Detalle Dispositivo -->
        <div id="device-detail-view" class="view">
            <div class="app-container">
                <!-- Header compacto -->
                <section class="header-section">
                    <div class="header-content">
                        <div class="device-title-area">
                            <h1 class="device-title" id="device-detail-title">Dispositivo</h1>
                            <span class="device-reference" id="device-reference">REF</span>
                            <div class="device-status-badge" id="device-status-badge">
                                <div class="status-dot"></div>
                                <span id="device-status-text">Estado</span>
                            </div>
                        </div>
                        <button id="btn-back-from-detail" class="btn btn-secondary">
                            ‚Üê Volver
                        </button>
                    </div>
                </section>

                <!-- Grid principal -->
                <div class="main-grid">
                    <!-- Panel de informaci√≥n -->
                    <div class="info-panel">
                        <h3 class="panel-title">
                            üìã Informaci√≥n del Dispositivo
                        </h3>
                        <div class="info-grid" id="device-info">
                            <!-- Info del dispositivo se carga din√°micamente -->
                        </div>
                    </div>

                    <!-- Panel de upload -->
                    <div class="upload-panel">
                        <h3 class="panel-title">
                            üìÅ Importar CSV
                        </h3>
                        <div class="upload-area" id="upload-area">
                            <div class="upload-icon">üìÑ</div>
                            <p class="upload-text">
                                Arrastra tu archivo CSV aqu√≠ o 
                                <span class="upload-link">selecciona un archivo</span>
                            </p>
                            <input type="file" id="csv-file-input" accept=".csv" hidden>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n de transmisi√≥n -->
                <section class="transmission-section" id="transmission-section">
                    <div class="transmission-header">
                        <h3 class="panel-title">
                            üì° Configuraci√≥n de Transmisi√≥n
                        </h3>
                        <div class="transmission-status-compact">
                            <div class="status-indicator-container">
                                <div id="transmission-state-indicator" class="transmission-indicator state-inactive"></div>
                                <span id="transmission-state-text" class="state-text">Inactivo</span>
                            </div>
                        </div>
                    </div>

                    <!-- Controles del sensor -->
                    <div class="sensor-controls" id="sensor-controls" style="display: none;">
                        <div class="current-position">
                            <span class="position-info">
                                Posici√≥n actual: <span class="position-value" id="current-row-index">0</span>
                            </span>
                            <button id="btn-reset-sensor" class="btn btn-warning btn-sm">
                                üîÑ Reiniciar Posici√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Grid de configuraci√≥n -->
                    <div class="config-grid">
                        <div class="form-group">
                            <label>Tipo de Dispositivo</label>
                            <select id="device-type" name="device_type">
                                <option value="WebApp">üì± WebApp (Env√≠o completo)</option>
                                <option value="Sensor">üî¨ Sensor (Fila por fila)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Frecuencia (segundos)</label>
                            <input type="number" id="transmission-frequency" name="transmission_frequency" min="1" value="3600">
                        </div>

                        <div class="form-group">
                            <label>Conexi√≥n para Transmisi√≥n</label>
                            <select id="transmission-connection" name="transmission_connection">
                                <option value="">Seleccionar conexi√≥n...</option>
                            </select>
                        </div>

                        <div class="checkbox-container">
                            <label class="checkbox-label">
                                <input type="checkbox" id="transmission-enabled" name="transmission_enabled">
                                <span>Transmisi√≥n autom√°tica habilitada</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-device-id" name="include_device_id_in_payload">
                                <span>Incluir device_id en payload</span>
                            </label>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="action-buttons">
                        <button id="btn-save-transmission-config" class="btn btn-primary">
                            üíæ Guardar Configuraci√≥n
                        </button>
                        <button id="btn-transmit-now" class="btn btn-success">
                            üì§ Transmitir Ahora
                        </button>
                        <button id="btn-pause-transmission" class="btn btn-warning" style="display: none;">
                            ‚è∏Ô∏è Pausar
                        </button>
                        <button id="btn-resume-transmission" class="btn btn-info" style="display: none;">
                            ‚ñ∂Ô∏è Reanudar
                        </button>
                        <button id="btn-stop-transmission" class="btn btn-danger" disabled>
                            ‚èπÔ∏è Parar
                        </button>
                    </div>
                </section>

                <!-- Historial de transmisiones -->
                <section class="history-section">
                    <div class="transmission-header">
                        <h3 class="panel-title">
                            üìã Historial de Transmisiones
                        </h3>
                        <div class="history-controls">
                            <select id="history-filter-status" class="filter-select">
                                <option value="">Todos los estados</option>
                                <option value="SUCCESS">Exitosas</option>
                                <option value="FAILED">Fallidas</option>
                            </select>
                            <select id="history-filter-connection" class="filter-select">
                                <option value="">Todas las conexiones</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="exportTransmissionHistory()">
                                üì• Exportar
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="refreshTransmissionHistory()">
                                üîÑ Actualizar
                            </button>
                        </div>
                    </div>
                    <div id="transmission-history-list" class="history-list">
                        <div class="empty-state">Sin transmisiones</div>
                    </div>
                    <div class="history-pagination" id="history-pagination" style="display: none;">
                        <button class="btn btn-sm" onclick="loadHistoryPage('prev')">‚Üê Anterior</button>
                        <span id="history-page-info">P√°gina 1</span>
                        <button class="btn btn-sm" onclick="loadHistoryPage('next')">Siguiente ‚Üí</button>
                    </div>
                </section>

                <!-- Preview mejorado -->
                <section class="preview-section" id="preview-section" style="display: none;">
                    <h3 class="panel-title">
                        üëÅÔ∏è Previsualizaci√≥n
                    </h3>
                    
                    <div class="preview-tabs">
                        <button class="preview-tab active" data-tab="csv">Vista CSV</button>
                        <button class="preview-tab" data-tab="json">Vista JSON</button>
                    </div>

                    <div class="preview-content" id="preview-content">
                        <div class="table-container">
                            <table id="csv-preview-table" class="preview-table">
                                <!-- Tabla CSV se genera din√°micamente -->
                            </table>
                        </div>
                    </div>

                    <div class="preview-actions">
                        <button id="btn-cancel-upload" class="btn btn-secondary">Cancelar</button>
                        <button id="btn-save-csv" class="btn btn-primary">Guardar Datos</button>
                        <button id="btn-send-data" class="btn btn-success" style="display: none;">
                            üì§ Enviar a Conexi√≥n
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Vista: Lista de Conexiones -->
        <div id="connections-list-view" class="view">
            <div class="view-header">
                <h2>üîó Conexiones Externas</h2>
                <button id="btn-new-connection" class="btn btn-primary">Nueva Conexi√≥n</button>
            </div>
            
            <div class="connections-grid" id="connections-grid">
                <div class="loading" id="connections-loading">Cargando conexiones...</div>
            </div>
        </div>

        <!-- Vista: Crear/Editar Conexi√≥n -->
        <div id="connection-form-view" class="view">
            <div class="view-header">
                <h2 id="connection-form-title">Nueva Conexi√≥n</h2>
                <button id="btn-back-to-connections" class="btn btn-secondary">Volver</button>
            </div>
            
            <form id="connection-form" class="form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="connection-name">Nombre *</label>
                        <input type="text" id="connection-name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="connection-type">Tipo de Conexi√≥n *</label>
                        <select class="filter-select" id="connection-type" name="type" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="MQTT">üîÑ MQTT (Mosquitto)</option>
                            <option value="HTTPS">üåê HTTPS REST API</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="connection-description">Descripci√≥n</label>
                    <textarea id="connection-description" name="description" rows="2"></textarea>
                </div>
                
                <div class="form-section">
                    <h3>üåê Configuraci√≥n de Servidor</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="connection-host">Host/Servidor *</label>
                            <input type="text" id="connection-host" name="host" placeholder="ejemplo.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="connection-port">Puerto</label>
                            <input type="number" id="connection-port" name="port" placeholder="1883">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="connection-endpoint">Endpoint/Topic</label>
                        <input type="text" id="connection-endpoint" name="endpoint" placeholder="/api/data o devices/topic">
                        <small class="form-help">Para HTTPS: ruta del endpoint. Para MQTT: topic de destino</small>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üîê Autenticaci√≥n</h3>
                    <div class="form-group">
                        <label for="auth-type">Tipo de Autenticaci√≥n *</label>
                        <select class="filter-select" id="auth-type" name="auth_type" required>
                            <option value="NONE">üîì Sin Autenticaci√≥n</option>
                            <option value="USER_PASS">üë§ Usuario y Contrase√±a</option>
                            <option value="TOKEN">üé´ Token Bearer</option>
                            <option value="API_KEY">üîë API Key</option>
                        </select>
                    </div>
                    
                    <!-- Campos de autenticaci√≥n din√°micos -->
                    <div id="auth-fields"></div>
                </div>
                
                <!-- Configuraci√≥n avanzada por tipo -->
                <div id="advanced-config" class="form-section" style="display: none;">
                    <h3>‚öôÔ∏è Configuraci√≥n Avanzada</h3>
                    <div id="advanced-fields"></div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span id="connection-submit-text">Crear Conexi√≥n</span>
                    </button>
                    <button type="button" id="btn-test-connection" class="btn btn-info" disabled>
                        üß™ Probar Conexi√≥n
                    </button>
                    <button type="button" id="btn-cancel-connection" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Vista: Detalle de Conexi√≥n -->
        <div id="connection-detail-view" class="view">
            <div class="view-header">
                <h2 id="connection-detail-title">Detalle de Conexi√≥n</h2>
                <div class="header-actions">
                    <button id="btn-edit-connection" class="btn btn-info">‚úèÔ∏è Editar</button>
                    <button id="btn-test-connection-detail" class="btn btn-success">üß™ Probar</button>
                    <button id="btn-back-from-connection-detail" class="btn btn-secondary">Volver</button>
                </div>
            </div>
            
            <div class="connection-info" id="connection-info">
                <!-- Info de la conexi√≥n se carga din√°micamente -->
            </div>
            
            <div class="connection-history">
                <h3>üìä Historial de Pruebas</h3>
                <div class="history-list" id="connection-history-list">
                    <div class="loading">Cargando historial...</div>
                </div>
            </div>
        </div>

        <!-- Vista: Lista de Proyectos -->
        <div id="projects-list-view" class="view">
            <div class="view-header">
                <h2>üìÅ Proyectos</h2>
                <button id="btn-new-project" class="btn btn-primary">Nuevo Proyecto</button>
            </div>
            
            <div class="projects-grid" id="projects-grid">
                <div class="loading" id="projects-loading">Cargando proyectos...</div>
            </div>
        </div>

        <!-- Vista: Crear/Editar Proyecto -->
        <div id="project-form-view" class="view">
            <div class="view-header">
                <h2 id="project-form-title">Nuevo Proyecto</h2>
                <button id="btn-back-to-projects" class="btn btn-secondary">Volver</button>
            </div>
            
            <form id="project-form" class="form">
                <div class="form-group">
                    <label for="project-name">Nombre del Proyecto *</label>
                    <input type="text" id="project-name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="project-description">Descripci√≥n</label>
                    <textarea id="project-description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span id="project-submit-text">Crear Proyecto</span>
                    </button>
                    <button type="button" id="btn-cancel-project" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Vista: Detalle de Proyecto -->
        <div id="project-detail-view" class="view">
            <div class="view-header">
                <h2 id="project-detail-title">Detalle de Proyecto</h2>
                <div class="header-actions">
                    <button id="btn-edit-project" class="btn btn-info">‚úèÔ∏è Editar</button>
                    <button id="btn-delete-project" class="btn btn-danger">üóëÔ∏è Eliminar</button>
                    <button id="btn-back-from-project-detail" class="btn btn-secondary">Volver</button>
                </div>
            </div>
            
            <div class="project-info" id="project-info">
                <!-- Info del proyecto se carga din√°micamente -->
            </div>

            <!-- Control de Transmisiones Masivas -->
            <div class="project-transmission-control">
                <h3>üì° Control de Transmisiones</h3>
                
                <div class="transmission-status">
                    <div class="status-indicator-container">
                        <div id="project-transmission-indicator" class="transmission-indicator state-inactive"></div>
                        <span id="project-transmission-text" class="state-text">Inactivo</span>
                    </div>
                </div>
                
                <div class="transmission-config">
                    <div class="form-group">
                        <label for="project-connection-selector">Conexi√≥n para Transmisi√≥n</label>
                        <select class="filter-select" id="project-connection-selector" name="connection_id">
                            <option value="">Usar conexi√≥n de cada dispositivo</option>
                        </select>
                    </div>
                    
                    <div class="transmission-actions">
                        <button id="btn-start-project-transmission" class="btn btn-success">üöÄ Iniciar Transmisiones</button>
                        <button id="btn-pause-project-transmission" class="btn btn-warning">‚è∏Ô∏è Pausar</button>
                        <button id="btn-resume-project-transmission" class="btn btn-info">‚ñ∂Ô∏è Reanudar</button>
                        <button id="btn-stop-project-transmission" class="btn btn-danger">‚èπÔ∏è Parar</button>
                    </div>
                </div>
            </div>

            <!-- Gesti√≥n de Dispositivos del Proyecto -->
            <div class="project-devices">
                <div class="devices-header">
                    <h3>üì± Dispositivos del Proyecto</h3>
                    <button id="btn-add-devices-to-project" class="btn btn-primary btn-medium">‚ûï Agregar Dispositivos</button>
                </div>
                
                <div class="project-devices-list" id="project-devices-list">
                    <div class="loading">Cargando dispositivos...</div>
                </div>
            </div>

            <!-- Historial de Transmisiones del Proyecto -->
            <div class="project-transmission-history">
                <div class="history-header">
                    <h3>üìã Historial de Transmisiones</h3>
                    <div class="history-controls">
                        <select id="project-history-filter-device" class="filter-select">
                            <option value="">Todos los dispositivos</option>
                        </select>
                        <select id="project-history-filter-status" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="SUCCESS">Exitosas</option>
                            <option value="FAILED">Fallidas</option>
                        </select>
                        <button class="btn btn-sm btn-secondary" onclick="exportProjectTransmissionHistory()">üì• Exportar</button>
                        <button class="btn btn-sm btn-primary" onclick="refreshProjectTransmissionHistory()">üîÑ</button>
                    </div>
                </div>
                <div id="project-transmission-history-list" class="history-list">
                    <div class="loading">Sin transmisiones</div>
                </div>
            </div>
        </div>

        <!-- Modal de Env√≠o de Datos -->
        <div id="send-data-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üì§ Enviar Datos del Dispositivo</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Selecciona una conexi√≥n para enviar los datos:</p>
                    <div class="connections-selector" id="connections-selector">
                        <!-- Lista de conexiones activas -->
                    </div>
                    <div class="data-preview">
                        <h4>Vista previa de los datos:</h4>
                        <pre id="send-data-preview"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-confirm-send" class="btn btn-primary">Enviar</button>
                    <button id="btn-cancel-send" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Transmisi√≥n Manual -->
        <div id="transmit-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üì° Transmisi√≥n Manual</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Selecciona una conexi√≥n para la transmisi√≥n:</p>
                    <div class="connections-selector" id="transmit-connections-selector">
                        <!-- Lista de conexiones activas -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-confirm-transmit" class="btn btn-primary">Transmitir</button>
                    <button id="btn-cancel-transmit" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Selecci√≥n de Dispositivos para Proyecto -->
        <div id="add-devices-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ûï Agregar Dispositivos al Proyecto</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Selecciona los dispositivos que deseas agregar al proyecto:</p>
                    <div class="devices-selector" id="unassigned-devices-selector">
                        <!-- Lista de dispositivos sin asignar -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-confirm-add-devices" class="btn btn-primary">Agregar Seleccionados</button>
                    <button id="btn-cancel-add-devices" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Duplicaci√≥n de Dispositivos -->
        <div id="duplicate-device-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîÑ Duplicar Dispositivo</h3>
                    <button class="modal-close" onclick="hideDuplicateModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p>¬øCu√°ntas copias deseas crear de "<span id="device-name-to-duplicate"></span>"?</p>
                    <div class="form-group">
                        <label for="duplicate-count">N√∫mero de duplicados:</label>
                        <input type="number" id="duplicate-count" min="1" max="50" value="1">
                    </div>
                    <div class="duplicate-preview">
                        <h4>Vista previa de nombres:</h4>
                        <ul id="duplicate-names-preview"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-confirm-duplicate" class="btn btn-primary">Duplicar</button>
                    <button id="btn-cancel-duplicate" class="btn btn-secondary" onclick="hideDuplicateModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Eliminaci√≥n de Dispositivos -->
        <div id="delete-device-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üóëÔ∏è Eliminar Dispositivo</h3>
                    <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Vas a eliminar el dispositivo "<span id="device-name-to-delete"></span>".</p>
                    <p><strong>Esta acci√≥n es permanente y no se podr√° recuperar.</strong> ¬øDeseas continuar?</p>
                </div>
                <div class="modal-footer">
                    <button id="btn-confirm-delete" class="btn btn-danger">Eliminar</button>
                    <button id="btn-cancel-delete" class="btn btn-secondary" onclick="hideDeleteModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Resultados de Operaciones -->
        <div id="operation-results-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="operation-title">Resultado de Operaci√≥n</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="operation-summary">
                        <!-- Resumen de la operaci√≥n -->
                    </div>
                    <div class="operation-details">
                        <!-- Detalles por dispositivo -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="hideOperationResultsModal()">Cerrar</button>
                </div>
            </div>
        </div>

                    </div>
        </main>
    </div>

    <!-- Notificaciones -->
    <div id="notifications" class="notifications-container"></div>

    <script src="i18n.js"></script>
    <script src="transmission-api.js"></script>
    <script src="realtime.js"></script>
    <script src="script.js"></script>
</body>
</html>
